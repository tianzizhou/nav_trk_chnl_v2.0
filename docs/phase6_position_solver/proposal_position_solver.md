# 位置解算模块 — 技术方案文档

## 1. 概述与目标

位置解算模块将跟踪器输出的相机坐标系 3D 状态转换为战术可用的
目标报告：方位角、俯仰角、斜距、相对速度和碰撞预警时间（TTC）。

### 1.1 输出需求

| 输出量 | 精度要求 | 更新率 |
|--------|----------|--------|
| 方位角 (Azimuth) | < 0.5° | 每帧 |
| 俯仰角 (Elevation) | < 0.5° | 每帧 |
| 斜距 (Slant Range) | < 5% | 每帧 |
| 相对速度 | < 10% | 每帧 |
| TTC (碰撞预警) | < 100ms | 每帧 |
| NED 坐标 | < 5m (近距) | 每帧 |
| 威胁等级 | 正确分级 | 每帧 |

---

## 2. 需求分析

### 2.1 位置解算方法对比

| 方法 | 输入 | 精度 | 延迟 | 适用性 |
|------|------|------|------|--------|
| **直接几何计算** | 相机坐标位置 | ★★★★ | ★★★★★ | **推荐** |
| 迭代非线性优化 | 原始像素+约束 | ★★★★★ | ★★★ | 高精度需求 |
| 滤波后输出 | EKF状态 | ★★★★ | ★★★★★ | **已采用** |

**推荐方案**：直接从 EKF 滤波后状态进行几何计算。
EKF 已经融合了多帧信息，输出比单帧测量更平滑更准确。

### 2.2 坐标系选择分析

| 坐标系 | 定义 | 优势 | 劣势 | 适用性 |
|--------|------|------|------|--------|
| **NED** | North-East-Down | 航空标准，直观 | 局部坐标 | **推荐** |
| ENU | East-North-Up | 测绘标准 | 航空不常用 | 不推荐 |
| ECEF | 地心固联 | 全球统一 | 不直观 | 远程通信用 |

**选择 NED**：航空领域标准坐标系，与 IMU 输出一致，便于姿态融合。

### 2.3 方位角定义规范

两种常见定义：

| 定义 | 参考方向 | 正方向 | 使用场景 |
|------|----------|--------|----------|
| 以北为0° | 地理北 | 顺时针 | 导航/雷达 |
| **以前为0°** | 相机前方 | 向右为正 | **视觉系统** |

**选择以前为0°**：相机系统中，方位角以光轴（Z轴）为基准更自然。

公式：α = atan2(X_cam, Z_cam)
- 0° = 正前方
- +90° = 正右方
- -90° = 正左方

### 2.4 TTC 计算方法对比

| 方法 | 公式 | 适用场景 | 精度 |
|------|------|----------|------|
| **线性 TTC** | R / V_closing | 匀速接近 | ★★★ |
| 二次 TTC | 解二次方程含加速度 | 匀加速接近 | ★★★★ |

**选择线性 TTC**：匀速接近假设在短时预测（<5s）内足够准确。
径向接近速度从 EKF 速度估计中分解。

---

## 3. 推荐方案总结

- **位置解算**：直接从 EKF 滤波后状态进行几何计算
- **坐标系**：NED（North-East-Down）
- **方位角**：以相机前方为0°，向右为正
- **TTC**：线性模型 TTC = R / V_closing
- **威胁评估**：基于 TTC 的三级分类

---

## 4. 关键公式

### 4.1 方位角

\[
\alpha = \arctan2(X_{cam}, Z_{cam})
\]

### 4.2 俯仰角

\[
\beta = \arctan2(-Y_{cam}, Z_{cam})
\]

注：相机 Y 轴向下，取负号使俯仰角向上为正。

### 4.3 斜距

\[
R = \sqrt{X_{cam}^2 + Y_{cam}^2 + Z_{cam}^2}
\]

### 4.4 径向接近速度

\[
V_{closing} = -\mathbf{V}_{rel} \cdot \frac{\mathbf{P}_{rel}}{|\mathbf{P}_{rel}|}
\]

正值 = 接近，负值 = 远离。

### 4.5 碰撞预警时间

\[
TTC = \frac{R}{V_{closing}}, \quad V_{closing} > 0
\]

\[
TTC = \infty, \quad V_{closing} \leq 0
\]

### 4.6 坐标变换链

```
P_cam → R_cam2body * P_cam + T_cam2body → P_body
P_body → R_body2ned(roll, pitch, yaw) * P_body → P_ned
```

---

## 5. 威胁评估分级

| TTC 范围 | 等级 | 建议动作 | 颜色编码 |
|----------|------|----------|----------|
| > 5.0 s | **safe** | 持续监视 | 绿色 |
| 2.0 ~ 5.0 s | **warning** | 准备规避 | 黄色 |
| < 2.0 s | **critical** | 立即规避 | 红色 |
| TTC = ∞ | **safe** | 目标远离 | 绿色 |

---

## 6. 风险评估

| 风险 | 概率 | 影响 | 缓解 |
|------|------|------|------|
| EKF 速度估计不准导致 TTC 误差 | 中 | 中 | 多帧平滑 + 加大 TTC 余量 |
| IMU 姿态误差影响 NED 变换 | 低 | 低 | IMU 精度通常 < 0.1° |
| 极近距离（<10m）数值精度 | 低 | 中 | 最小距离限制（0.1m） |

---

## 7. 参考资料

1. Groves, P.D. "Principles of GNSS, Inertial, and Multisensor Integrated
   Navigation Systems." 2nd Edition, 2013.
2. IEEE Std 1278.1 — Standard for Distributed Interactive Simulation.
