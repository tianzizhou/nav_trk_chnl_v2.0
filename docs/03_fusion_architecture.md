# 融合架构与数据流设计

## 1 文档信息

| 项目 | 内容 |
|------|------|
| 文档编号 | CUAV-FUS-003 |
| 版本 | V1.0.0 |
| 日期 | 2026-02-20 |

---

## 2 概述

本文档详细描述多模态融合反无人机探测系统的融合架构设计，包括融合层次
划分、数据流路径、坐标系定义、时间同步机制以及融合处理平台的软件架构。

---

## 3 融合理论基础

### 3.1 JDL 数据融合模型

系统融合架构基于 JDL（Joint Directors of Laboratories）数据融合模型
的改进版，将融合处理划分为以下层次：

| JDL 层次 | 本系统对应 | 功能描述 |
|----------|-----------|---------|
| Level 0 | 信号预处理 | 各传感器内部信号处理、检测、特征提取 |
| Level 1 | 目标级融合 | 航迹关联、状态估计、航迹管理 |
| Level 2 | 态势评估 | 行为分析、意图判断 |
| Level 3 | 威胁评估 | 威胁等级、打击优先级 |
| Level 4 | 过程优化 | 传感器管理、资源调度 |

### 3.2 融合架构选择

本系统采用 **集中式 + 分层递阶** 的混合融合架构：

```
┌────────────────────────────────────────────────────────────┐
│                                                            │
│  分布式传感器处理           集中式融合处理                  │
│  ┌──────────────┐          ┌──────────────────────────┐    │
│  │ 传感器 1     │          │                          │    │
│  │ 本地处理     │──────────▶                          │    │
│  └──────────────┘          │                          │    │
│  ┌──────────────┐          │   融合中心               │    │
│  │ 传感器 2     │──────────▶   · 航迹关联             │    │
│  │ 本地处理     │          │   · 状态估计             │    │
│  └──────────────┘          │   · 航迹管理             │    │
│  ┌──────────────┐          │   · 分类融合             │    │
│  │ 传感器 3     │──────────▶   · 态势/威胁评估        │    │
│  │ 本地处理     │          │                          │    │
│  └──────────────┘          │                          │    │
│  ┌──────────────┐          │                          │    │
│  │ 传感器 4     │──────────▶                          │    │
│  │ 本地处理     │          │                          │    │
│  └──────────────┘          └──────────────────────────┘    │
│                                                            │
│  优点:                                                     │
│  · 各传感器独立预处理(分布式) → 降低通信带宽              │
│  · 集中融合处理 → 全局最优关联和估计                      │
│  · 分层递阶 → 清晰的处理流水线                            │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## 4 分层融合架构详细设计

### 4.1 总体架构

```
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                Level 4: 过程优化 (传感器管理)              │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                 │  │
│  │  │ 传感器   │  │ 资源     │  │ 场景     │                 │  │
│  │  │ 调度     │  │ 分配     │  │ 自适应   │                 │  │
│  │  └──────────┘  └──────────┘  └──────────┘                 │  │
│  └────────────────────────┬───────────────────────────────────┘  │
│                           │ 反馈控制                             │
│  ┌────────────────────────▼───────────────────────────────────┐  │
│  │                Level 3: 威胁评估                           │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                 │  │
│  │  │ 威胁     │  │ 打击     │  │ 打击     │                 │  │
│  │  │ 等级     │  │ 优先级   │  │ 建议     │                 │  │
│  │  └──────────┘  └──────────┘  └──────────┘                 │  │
│  └────────────────────────┬───────────────────────────────────┘  │
│                           │                                      │
│  ┌────────────────────────▼───────────────────────────────────┐  │
│  │                Level 2: 态势评估                           │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                 │  │
│  │  │ 行为     │  │ 意图     │  │ 轨迹     │                 │  │
│  │  │ 识别     │  │ 判断     │  │ 预测     │                 │  │
│  │  └──────────┘  └──────────┘  └──────────┘                 │  │
│  └────────────────────────┬───────────────────────────────────┘  │
│                           │                                      │
│  ┌────────────────────────▼───────────────────────────────────┐  │
│  │                Level 1: 目标级融合 (核心)                  │  │
│  │                                                            │  │
│  │  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐        │  │
│  │  │坐标  │─▶│航迹  │─▶│状态  │─▶│航迹  │─▶│分类  │        │  │
│  │  │变换  │  │关联  │  │估计  │  │管理  │  │融合  │        │  │
│  │  │      │  │(JPDA)│  │(IMM- │  │(M/N) │  │(D-S) │        │  │
│  │  │      │  │      │  │ UKF) │  │      │  │      │        │  │
│  │  └──────┘  └──────┘  └──────┘  └──────┘  └──────┘        │  │
│  └────────────────────────┬───────────────────────────────────┘  │
│                           │                                      │
│  ┌────────────────────────▼───────────────────────────────────┐  │
│  │                Level 0: 信号/检测级预处理                  │  │
│  │                                                            │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌───────────┐  │  │
│  │  │ 雷达     │  │ 光电     │  │ 声学     │  │ RF        │  │  │
│  │  │ 信号处理 │  │ 图像处理 │  │ 信号处理 │  │ 信号处理  │  │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └───────────┘  │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 4.2 Level 0：信号/检测级预处理

**功能**：各传感器内部完成信号处理，输出标准化的量测报告（点迹）。

**输入**：传感器原始数据（ADC采样、图像帧、音频流、RF信号）

**输出**：标准化点迹报告（含量测值、精度估计、特征信息）

**处理位置**：
- 雷达信号处理：FPGA + 嵌入式处理器（雷达模组内部）
- 光电图像处理：GPU (Jetson Orin AGX)
- 声学信号处理：FPGA + CPU
- RF信号处理：RF模组内部处理器

各传感器输出数据率：

| 传感器 | 输出数据率 | 单帧数据量 |
|--------|-----------|-----------|
| 雷达 | 5 Hz (点迹), 5 Hz (RD Map) | ~2 KB (点迹), ~2 MB (RD Map) |
| 光电 | 30 Hz (跟踪结果) | ~200 B |
| 声学 | 10 Hz (DOA报告) | ~300 B |
| RF | 20 Hz (信号报告) | ~100 B |

### 4.3 Level 1：目标级融合

**功能**：将多传感器量测关联到航迹，更新航迹状态，管理航迹生命周期。

Level 1 融合是整个系统的核心，包含五个子模块：

```
量测输入 → [坐标变换] → [航迹关联] → [状态估计] → [航迹管理] → [分类融合]
  ↑                                                               │
  │                         融合航迹输出                           │
  └──────────── 反馈: 传感器引导指令 ──────────────────────────────┘
```

#### 4.3.1 坐标变换子模块

将各传感器量测统一到公共坐标系。

**输入**：各传感器的本地量测（不同坐标系、不同维度）

**输出**：统一坐标系下的量测向量 + 量测噪声矩阵

详见第 5 节坐标系定义。

#### 4.3.2 航迹关联子模块

将当前周期的量测分配到已有航迹。

**算法**：JPDA（联合概率数据关联）

**输入**：
- 当前周期所有量测 \(\{z_i\}\)
- 所有航迹的预测量测 \(\{\hat{z}_j\}\) 和新息协方差 \(\{S_j\}\)

**输出**：
- 关联概率矩阵 \(\{\beta_{ij}\}\)
- 未关联量测列表（用于航迹起始）

**计算复杂度控制**：
- 关联门限预筛选：马氏距离 > 门限的量测-航迹对直接排除
- 典型场景（<10目标, <50量测），JPDA 实时可行
- 若目标数 > 20，降级为 GNN（全局最近邻）以保证实时性

#### 4.3.3 状态估计子模块

融合多传感器量测，更新航迹状态。

**算法**：IMM-UKF（交互多模型 - 无迹卡尔曼滤波）

**输入**：
- 上一时刻状态估计 + 协方差
- 关联后的量测及关联概率

**输出**：
- 更新后的状态估计（位置、速度）
- 协方差矩阵
- 各模型概率

**处理方式**：序贯更新（按雷达→光电→声学→RF顺序）

#### 4.3.4 航迹管理子模块

管理航迹的生命周期：起始、确认、维持、终止。

**航迹状态机**：

```
                ┌─────────┐
                │  空闲    │
                └────┬────┘
                     │ 未关联量测
                ┌────▼────┐
           ┌────│  候选    │────┐
           │    │ (单点)   │    │
           │    └────┬────┘    │
           │         │ 连续关联 │ 超时无关联
           │    ┌────▼────┐    │
           │    │  暂态    │────┘
           │    │ (M/N)   │
           │    └────┬────┘
           │         │ 多传感器确认
           │    ┌────▼────┐
           │    │  确认    │
           │    │ (跟踪中) │
           │    └────┬────┘
           │         │ 连续无更新
           │    ┌────▼────┐
           │    │  外推    │
           │    │ (预测)   │
           │    └────┬────┘
           │         │ 超时
           │    ┌────▼────┐
           └───▶│  终止    │
                │ (删除)   │
                └─────────┘
```

**状态转移条件**：

| 转移 | 条件 |
|------|------|
| 空闲 → 候选 | 出现未关联量测 |
| 候选 → 暂态 | M/N 检测（雷达 2/3, 声学/RF 4/5） |
| 暂态 → 确认 | 被第 2 种传感器关联更新 |
| 确认 → 外推 | 连续 20 帧 (4s) 无量测更新 |
| 外推 → 终止 | 再 5 帧 (1s) 仍无更新 |
| 外推 → 确认 | 重新被量测关联 |
| 暂态 → 终止 | 连续 10 帧 (2s) 无确认 |

#### 4.3.5 分类融合子模块

融合多传感器的目标分类结果。

**算法**：D-S 证据理论

**输入**：各传感器的分类 BPA（基本概率分配）

**输出**：融合分类结果 + 置信度

### 4.4 Level 2：态势评估

**功能**：分析目标行为模式，判断目标意图。

```
融合航迹 → [运动模式识别] → [意图推断] → [态势图更新]
              │                │
              ▼                ▼
         行为标签          意图标签
         · 直飞接近         · 侦察
         · 环绕侦察         · 攻击
         · 蛙跳接近         · 干扰
         · 远距徘徊         · 投放
         · 悬停观察         · 无害
```

**行为分析方法**：

| 行为模式 | 检测特征 |
|---------|---------|
| 直飞接近 | \(\dot{R} < 0\) 持续，航向角变化 < 5° |
| 环绕侦察 | 转弯率 > 3°/s 持续 > 10s，距离基本不变 |
| 蛙跳接近 | IMM 悬停/CV 模型概率交替 > 0.6，整体接近 |
| 悬停观察 | 悬停模型概率 > 0.8 持续 > 5s |
| 远距徘徊 | 距离 > 2000 m，速度方向频繁变化 |

### 4.5 Level 3：威胁评估

**功能**：综合目标属性和行为，评估威胁等级。

**威胁评估公式**：

\[
S_{threat} = w_1 f_R(R) + w_2 f_V(\dot{R}) + w_3 f_B(B) + w_4 f_C(C)
\]

| 因子 | 函数 | 说明 |
|------|------|------|
| 距离因子 \(f_R\) | \(1 - R/R_{max}\) | 距离越近威胁越高 |
| 接近速率因子 \(f_V\) | \(\max(0, -\dot{R}/V_{max})\) | 接近速度越快威胁越高 |
| 行为因子 \(f_B\) | 查表 | 直飞接近=1.0, 蛙跳=0.9, 环绕=0.5, 徘徊=0.2 |
| 分类因子 \(f_C\) | 查表 | 多旋翼=0.8, 固定翼=0.6, 鸟=0.0, 未知=0.5 |

**权重设置**：\(w_1 = 0.3, w_2 = 0.3, w_3 = 0.25, w_4 = 0.15\)

**威胁等级划分**：

| 等级 | 分值范围 | 含义 | 系统响应 |
|------|---------|------|---------|
| 红色 | > 0.8 | 高威胁 | 立即告警 + 自动引导打击 |
| 橙色 | 0.6 ~ 0.8 | 中高威胁 | 告警 + 准备打击 |
| 黄色 | 0.3 ~ 0.6 | 中威胁 | 持续跟踪 + 关注 |
| 绿色 | < 0.3 | 低威胁 | 继续监视 |

### 4.6 Level 4：过程优化（传感器管理）

**功能**：根据当前态势和传感器状态，动态调整传感器工作模式和参数。

**传感器管理策略**：

```
传感器管理决策逻辑:

(1) 光电引导:
    新暂态航迹建立 → 计算预测角度 → 引导光电云台指向
    优先级: 距离最近的未确认航迹

(2) 雷达工作模式切换:
    超低空目标检测 → 启用杂波图增强模式
    蛙跳模式识别 → 启用微多普勒检测模式

(3) 融合更新率调整:
    威胁等级 > 0.6 → 提升更新率至 50 Hz (打击引导)
    威胁等级 < 0.3 → 维持 5 Hz 搜索更新率

(4) 声学带宽分配:
    多目标场景 → MVDR波束跟踪优先目标
    单目标场景 → 全向MUSIC搜索

(5) 场景自适应:
    根据场景评估结果动态调整传感器可信度权重
    详见 05_scenario_strategies.md
```

---

## 5 坐标系定义与变换

### 5.1 坐标系定义

系统定义以下坐标系：

#### (1) 地理坐标系 (WGS-84)

\[
(\lambda, \varphi, h) \text{ — 经度、纬度、海拔高度}
\]

用于全局定位和与指控系统交互。

#### (2) 站心东北天坐标系 (ENU)

以平台位置为原点，三轴定义：
- E (East)：东向
- N (North)：北向
- U (Up)：天向

**这是系统内部的主坐标系**，所有融合处理在此坐标系下进行。

#### (3) 平台体坐标系

以平台中心为原点，固联于车体：
- X：车头方向
- Y：车体左侧
- Z：向上

#### (4) 传感器坐标系

各传感器自身的测量坐标系（球坐标或直角坐标）。

### 5.2 坐标变换

#### 雷达球坐标 → ENU

雷达量测为球坐标 \((R, Az, El)\)，其中 Az 从正北顺时针计量：

\[
x_E = R \cos(El) \sin(Az) + \Delta x_{radar}
\]

\[
y_N = R \cos(El) \cos(Az) + \Delta y_{radar}
\]

\[
z_U = R \sin(El) + \Delta z_{radar}
\]

其中 \((\Delta x_{radar}, \Delta y_{radar}, \Delta z_{radar})\) 为
雷达安装偏移。

#### 光电角度 → ENU 方向向量

光电仅提供角度量测，生成单位方向向量：

\[
\mathbf{d}_{EO} = [\sin(Az)\cos(El), \cos(Az)\cos(El), \sin(El)]^T
\]

在状态估计中，光电量测的观测方程为：

\[
h_{EO}(\mathbf{x}) = \begin{bmatrix} \arctan(x_E / y_N) \\ \arctan(z_U / \sqrt{x_E^2 + y_N^2}) \end{bmatrix}
\]

#### 声学 DOA → ENU 方向向量

与光电相同，仅提供方向信息：

\[
h_{acou}(\mathbf{x}) = \begin{bmatrix} \arctan(x_E / y_N) \\ \arctan(z_U / \sqrt{x_E^2 + y_N^2}) \end{bmatrix}
\]

#### RF 方位 → ENU

RF 仅提供方位角：

\[
h_{RF}(\mathbf{x}) = \arctan(x_E / y_N)
\]

### 5.3 量测雅可比矩阵

UKF 中非线性观测通过 Sigma 点直接处理，但 EKF 后备方案需要
雅可比矩阵：

**雷达量测雅可比** \(H_{radar}\)（6×4 矩阵，状态6维，量测4维）：

\[
H_{radar} = \frac{\partial h_{radar}}{\partial \mathbf{x}} = \begin{bmatrix} \frac{\partial R}{\partial x} & \frac{\partial R}{\partial \dot{x}} & \cdots \\ \frac{\partial Az}{\partial x} & \frac{\partial Az}{\partial \dot{x}} & \cdots \\ \frac{\partial El}{\partial x} & \frac{\partial El}{\partial \dot{x}} & \cdots \\ \frac{\partial \dot{R}}{\partial x} & \frac{\partial \dot{R}}{\partial \dot{x}} & \cdots \end{bmatrix}
\]

具体元素：

\[
\frac{\partial R}{\partial x} = \frac{x}{R}, \quad \frac{\partial R}{\partial y} = \frac{y}{R}, \quad \frac{\partial R}{\partial z} = \frac{z}{R}
\]

\[
\frac{\partial Az}{\partial x} = \frac{y}{x^2+y^2}, \quad \frac{\partial Az}{\partial y} = \frac{-x}{x^2+y^2}
\]

\[
\frac{\partial El}{\partial x} = \frac{-xz}{R^2\sqrt{x^2+y^2}}, \quad \frac{\partial El}{\partial z} = \frac{\sqrt{x^2+y^2}}{R^2}
\]

---

## 6 数据流设计

### 6.1 数据流总览

```
┌──────────────────────────────────────────────────────────────────────┐
│                         数据流架构                                   │
│                                                                      │
│  传感器层           预处理层              融合层           输出层     │
│                                                                      │
│  ┌──────┐     ┌────────────┐                                         │
│  │雷达  │────▶│雷达信号处理│──┐                                      │
│  │ADC   │     │(FPGA)     │  │                                      │
│  └──────┘     └────────────┘  │                                      │
│                               │  ┌──────────────────┐               │
│  ┌──────┐     ┌────────────┐  │  │                  │  ┌─────────┐  │
│  │光电  │────▶│图像处理   │──┼─▶│  融合处理核心    │─▶│指控接口 │  │
│  │相机  │     │(GPU)      │  │  │                  │  └─────────┘  │
│  └──────┘     └────────────┘  │  │  · 坐标变换     │               │
│                               │  │  · 航迹关联     │  ┌─────────┐  │
│  ┌──────┐     ┌────────────┐  │  │  · IMM-UKF     │─▶│打击引导 │  │
│  │声学  │────▶│声学信号处理│──┼─▶│  · 航迹管理     │  └─────────┘  │
│  │阵列  │     │(FPGA+CPU) │  │  │  · D-S分类     │               │
│  └──────┘     └────────────┘  │  │  · 态势评估     │  ┌─────────┐  │
│                               │  │  · 威胁评估     │─▶│态势显示 │  │
│  ┌──────┐     ┌────────────┐  │  │                  │  └─────────┘  │
│  │RF    │────▶│RF信号处理  │──┘  │                  │               │
│  │接收  │     │(模组内部)  │     │                  │  ┌─────────┐  │
│  └──────┘     └────────────┘     │                  │─▶│数据记录 │  │
│                                  └──────────────────┘  └─────────┘  │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

### 6.2 消息定义

系统内部通信采用 **定长二进制消息** 格式，通过 UDP 传输。

#### 消息头格式

```
┌─────────────────────────────────────────────┐
│ 字段           │ 类型     │ 字节 │ 说明    │
├─────────────────────────────────────────────┤
│ sync_word      │ uint16   │ 2    │ 0xEB90  │
│ msg_id         │ uint16   │ 2    │ 消息标识│
│ msg_length     │ uint16   │ 2    │ 有效载荷长度│
│ source_id      │ uint8    │ 1    │ 发送方ID│
│ dest_id        │ uint8    │ 1    │ 接收方ID│
│ timestamp_ms   │ uint32   │ 4    │ GPS时间戳│
│ sequence_num   │ uint16   │ 2    │ 序列号  │
│ reserved       │ uint16   │ 2    │ 保留    │
├─────────────────────────────────────────────┤
│ 消息头总长度: 16 字节                       │
└─────────────────────────────────────────────┘
```

#### 消息类型列表

| msg_id | 消息名称 | 方向 | 周期 |
|--------|---------|------|------|
| 0x0101 | 雷达点迹报告 | 雷达 → 融合 | 200 ms |
| 0x0102 | 雷达RD Map | 雷达 → 融合 | 200 ms |
| 0x0201 | 光电跟踪报告 | 光电 → 融合 | 33 ms |
| 0x0301 | 声学DOA报告 | 声学 → 融合 | 100 ms |
| 0x0401 | RF信号报告 | RF → 融合 | 50 ms |
| 0x1001 | 融合航迹报告 | 融合 → 指控 | 200 ms |
| 0x1002 | 打击引导数据 | 融合 → 打击 | 20 ms |
| 0x1003 | 态势信息 | 融合 → 显示 | 200 ms |
| 0x2001 | 光电引导指令 | 融合 → 光电 | 实时 |
| 0x2002 | 雷达模式指令 | 融合 → 雷达 | 实时 |
| 0x3001 | 指控控制指令 | 指控 → 融合 | 实时 |

### 6.3 数据带宽分析

| 链路 | 消息 | 数据率 |
|------|------|--------|
| 雷达 → 融合 | 点迹 (5Hz × 2KB) + RD Map (5Hz × 2MB) | ~10 MB/s |
| 光电 → 融合 | 跟踪报告 (30Hz × 200B) | ~6 KB/s |
| 声学 → 融合 | DOA报告 (10Hz × 300B) | ~3 KB/s |
| RF → 融合 | 信号报告 (20Hz × 100B) | ~2 KB/s |
| 融合 → 指控 | 航迹报告 (5Hz × 1KB) | ~5 KB/s |
| 融合 → 打击 | 引导数据 (50Hz × 200B) | ~10 KB/s |

总带宽需求 < 15 MB/s，千兆以太网完全满足。

---

## 7 融合处理时序设计

### 7.1 融合周期划分

标准融合周期 T = 200 ms (5 Hz)，划分为以下阶段：

```
时间轴 (ms):
0        20        50        60       80      100      120     140     160     180  200
│         │         │         │        │        │        │       │       │       │    │
│◀ P1 ─▶│         │         │        │        │        │       │       │       │    │
│ 雷达   │◀─ P2 ─▶│         │        │        │        │       │       │       │    │
│ 触发   │ 传感器  │◀ P3 ──▶│        │        │        │       │       │       │    │
│        │ 数据    │ 时间    │◀ P4 ─▶│        │        │       │       │       │    │
│        │ 预处理  │ 对齐/   │ 航迹   │◀ P5 ─▶│        │       │       │       │    │
│        │         │ 场景    │ 预测   │ JPDA   │◀ P6 ─▶│       │       │       │    │
│        │         │ 感知    │        │ 关联   │ IMM-   │◀ P7 ▶│       │       │    │
│        │         │         │        │        │ UKF    │ 航迹  │◀ P8 ▶│       │    │
│        │         │         │        │        │ 更新   │ 管理  │ 分类  │◀ P9 ▶│    │
│        │         │         │        │        │        │       │ 融合  │ 威胁  │◀P10│
│        │         │         │        │        │        │       │       │ 评估  │输出│
```

### 7.2 高更新率模式

进入打击引导模式后，更新率提升至 50 Hz (20 ms/周期)：

- 光电量测率已为 30 Hz，可支持
- 声学量测率为 10 Hz，通过内插补偿
- 雷达维持 5 Hz，两次雷达量测间使用模型预测
- RF 维持 20 Hz

高更新率模式仅对 **被引导的优先目标** 使用，其他目标维持 5 Hz。

### 7.3 流水线重叠

为提高处理效率，相邻融合周期的不同阶段采用流水线重叠：

```
周期 k:     [P1 P2 P3 P4 P5 P6 P7 P8 P9 P10]
周期 k+1:               [P1 P2 P3 P4 P5 P6 P7 P8 P9 P10]
周期 k+2:                           [P1 P2 P3 P4 P5 P6 ...]

实际延迟: ~120ms (从传感器采样到融合输出)
```

---

## 8 软件架构

### 8.1 软件模块划分

融合处理平台上的软件架构：

```
┌──────────────────────────────────────────────────────────────┐
│                     应用层                                    │
│                                                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐    │
│  │ 融合引擎 │ │ 态势评估 │ │ 传感器   │ │ 人机界面     │    │
│  │          │ │ 引擎     │ │ 管理     │ │ (HMI)       │    │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────┘    │
├──────────────────────────────────────────────────────────────┤
│                     中间件层                                  │
│                                                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐    │
│  │ 消息总线 │ │ 时间管理 │ │ 日志系统 │ │ 配置管理     │    │
│  │ (DDS)    │ │ (PTP/GPS)│ │          │ │              │    │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────┘    │
├──────────────────────────────────────────────────────────────┤
│                     操作系统层                                │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐    │
│  │           Linux RT (实时Linux内核)                    │    │
│  └──────────────────────────────────────────────────────┘    │
├──────────────────────────────────────────────────────────────┤
│                     硬件层                                    │
│                                                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐    │
│  │ Jetson   │ │ FPGA     │ │ 千兆     │ │ GPS/北斗     │    │
│  │ Orin AGX │ │ Xilinx   │ │ 以太网   │ │ 接收机       │    │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────┘    │
└──────────────────────────────────────────────────────────────┘
```

### 8.2 线程模型

```
┌────────────────────────────────────────────────────────────┐
│                    融合引擎线程模型                          │
│                                                            │
│  Thread 1: 通信收发                                        │
│    · 接收各传感器量测报告                                   │
│    · 写入环形缓冲区                                        │
│    · 发送融合结果和引导指令                                 │
│    · 周期: 事件驱动                                        │
│                                                            │
│  Thread 2: 融合主循环 (实时线程, 最高优先级)               │
│    · 读取传感器量测缓冲                                    │
│    · 执行融合处理流水线 (P1~P10)                           │
│    · 输出融合航迹                                          │
│    · 周期: 200ms (标准) / 20ms (引导)                     │
│                                                            │
│  Thread 3: 光电图像处理 (GPU线程)                          │
│    · YOLOv8 推理                                           │
│    · KCF 跟踪                                              │
│    · 周期: 33ms                                            │
│                                                            │
│  Thread 4: 态势评估                                        │
│    · 行为分析                                              │
│    · 威胁评估                                              │
│    · 周期: 200ms                                           │
│                                                            │
│  Thread 5: 数据记录                                        │
│    · 记录原始量测和融合结果                                 │
│    · 异步写入 SSD                                          │
│    · 周期: 事件驱动                                        │
│                                                            │
│  Thread 6: HMI 更新                                        │
│    · 更新态势显示                                          │
│    · 接收操作指令                                          │
│    · 周期: 100ms                                           │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 8.3 数据结构设计

**核心数据结构 — 融合航迹**：

```c
// 航迹状态枚举
typedef enum {
    TRACK_CANDIDATE  = 0,   // 候选
    TRACK_TENTATIVE  = 1,   // 暂态
    TRACK_CONFIRMED  = 2,   // 确认
    TRACK_COASTING   = 3,   // 外推
    TRACK_TERMINATED = 4    // 终止
} TrackStatus;

// 目标类型枚举
typedef enum {
    TARGET_UNKNOWN     = 0,
    TARGET_MULTIROTOR  = 1,   // 多旋翼
    TARGET_FIXEDWING   = 2,   // 固定翼
    TARGET_BIRD        = 3,   // 鸟类
    TARGET_OTHER       = 4
} TargetClass;

// 融合航迹结构体
typedef struct {
    uint32_t    track_id;           // 航迹编号
    TrackStatus status;             // 航迹状态
    uint32_t    create_time_ms;     // 创建时间
    uint32_t    update_time_ms;     // 最后更新时间
    uint32_t    confirm_time_ms;    // 确认时间

    // 状态估计 (ENU坐标系)
    float       pos_e_m;            // 东向位置 (m)
    float       pos_n_m;            // 北向位置 (m)
    float       pos_u_m;            // 天向位置 (m)
    float       vel_e_mps;          // 东向速度 (m/s)
    float       vel_n_mps;          // 北向速度 (m/s)
    float       vel_u_mps;          // 天向速度 (m/s)

    // 协方差矩阵 (6x6, 上三角存储)
    float       cov[21];

    // 球坐标 (冗余, 便于输出)
    float       range_m;
    float       azimuth_rad;
    float       elevation_rad;
    float       speed_mps;
    float       heading_rad;

    // CEP精度
    float       cep_m;              // 水平圆概率误差

    // IMM模型概率
    float       prob_cv;            // 匀速模型概率
    float       prob_ct;            // 转弯模型概率
    float       prob_hover;         // 悬停模型概率

    // 分类信息
    TargetClass target_class;
    float       class_confidence;   // 分类置信度

    // 威胁评估
    float       threat_score;       // 威胁分值 [0,1]
    uint8_t     threat_level;       // 威胁等级 (0~3)
    uint8_t     behavior_pattern;   // 行为模式

    // 传感器贡献标志
    uint8_t     sensor_contrib;     // bit0:雷达 bit1:光电
                                    // bit2:声学 bit3:RF

    // 航迹管理
    uint16_t    update_count;       // 累计更新次数
    uint16_t    miss_count;         // 连续未更新帧数
    uint8_t     confirm_sensor_cnt; // 确认传感器种类数

} FusionTrack;
```

---

## 9 可靠性与冗余设计

### 9.1 传感器故障降级

系统支持传感器故障时的优雅降级：

| 故障传感器 | 影响 | 降级策略 |
|-----------|------|---------|
| 雷达故障 | 丧失远距探测和测距能力 | 声学+RF+光电纯角度跟踪，测距靠高度约束 |
| 光电故障 | 丧失高精度角度和目标识别 | 雷达+声学跟踪，分类依赖雷达RCS+声学MFCC |
| 声学故障 | 丧失悬停/近距/城市补充探测 | 雷达+光电为主，蛙跳场景性能下降 |
| RF故障 | 丧失被动通信侦测 | 其他三传感器不受影响 |
| 仅剩1个传感器 | 大幅降级 | 单传感器独立工作，航迹置信度降低 |

### 9.2 处理平台冗余

- 融合算法关键参数存储于非易失存储器
- 看门狗定时器监控融合主循环
- 故障自动重启（恢复时间 < 5 s）

---

*文档结束*
