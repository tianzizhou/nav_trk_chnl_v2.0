# 目标跟踪模块 — 仿真验证文档

## 1. 仿真目的

验证 EKF 跟踪器的滤波性能（收敛性、精度）和多目标跟踪器的
关联正确性（ID 管理、状态机转换）。

---

## 2. 仿真环境

- 框架：pytest 单元测试（15项）+ 端到端场景验证（8场景）
- 采样率：120 Hz（EKF 单元测试）/ 10 Hz（场景验证）
- 测量噪声：高斯分布，σ=0.5~1.0m

---

## 3. EKF 单目标测试结果

### 3.1 测试1：位置初始化

输入 [100, 50, 200]，验证 get_position() 返回一致。

| 结果 | 误差 < 1e-10 | ✅ |

### 3.2 测试2：匀速预测

初始状态 [0,0,100, 10,0,0, 0,0,0]，predict(dt=0.1)：
- 预期 x = 0 + 10×0.1 = 1.0m
- 实测 x = 1.0m

| 结果 | 精确匹配 | ✅ |

### 3.3 测试3：预测后协方差增长

predict() 后 trace(P) 应增大（不确定性增加）。

| 结果 | trace(P_after) > trace(P_before) | ✅ |

### 3.4 测试4：测量更新减小协方差

update() 后 trace(P) 应减小（信息增加）。

| 结果 | trace(P_after) < trace(P_before) | ✅ |

### 3.5 测试5：静止目标收敛（位置估计）

真实位置 [10, -5, 200]，初始猜测 [0, 0, 100]。
50次 predict+update（测量噪声 σ=1m）后：

| 指标 | 值 |
|------|-----|
| 位置误差 | < 5.0m |
| 收敛速度 | ~10 次更新后稳态 |
| 结果 | ✅ 通过 |

### 3.6 测试6：运动目标速度估计

真实速度 [10, 0, 0] m/s，200次 predict+update后：

| 指标 | 值 |
|------|-----|
| 速度误差 | < 5.0 m/s |
| 收敛帧数 | ~50帧 |
| 结果 | ✅ 通过 |

### 3.7 测试7：预测不修改状态

get_predicted_position(dt=0.1) 调用后 x 状态不变。

| 结果 | x_before == x_after | ✅ |

---

## 4. 多目标跟踪测试结果

### 4.1 测试8：首帧创建轨迹

输入1个检测 → 创建1个 TENTATIVE 轨迹。

| 结果 | 轨迹数=1, status=TENTATIVE | ✅ |

### 4.2 测试9：确认状态转换

连续5帧提供同一检测 → 3帧后确认为 CONFIRMED。

| 结果 | confirmed_tracks > 0 | ✅ |

### 4.3 测试10：删除状态转换

创建轨迹后连续15帧无检测 → 轨迹被删除。

| 结果 | active_tracks = 0 | ✅ |

### 4.4 测试11：多目标独立跟踪

2个分离目标 [10,0,200] 和 [-10,0,300]，连续5帧：

| 指标 | 值 |
|------|-----|
| 确认轨迹数 | 2 |
| ID 唯一性 | 2个不同ID |
| 结果 | ✅ |

### 4.5 测试12：关联正确性

2个轨迹，检测有轻微偏移（±1m），验证匹配到正确轨迹。

| 结果 | 无新轨迹创建，关联正确 | ✅ |

### 4.6 测试13：门限外检测创建新轨迹

已有轨迹在 [100,0,200]，新检测在 [1000,0,500]（距离远超50m门限）。

| 结果 | 创建新轨迹，总数=2 | ✅ |

### 4.7 测试14：reset 清除

调用 reset() 后所有轨迹清空。

| 结果 | active_tracks = 0, next_id = 1 | ✅ |

### 4.8 测试15：ROI 预测生成

确认轨迹后生成下一帧的预测 ROI。

| 结果 | ROI 列表非空，每个 ROI 为 4 元素 | ✅ |

---

## 5. 端到端场景跟踪性能

以下为 8 场景 batch evaluation 中的跟踪相关统计（5s@10fps）：

| 场景 | 确认轨迹帧数占比 | 最大同时轨迹数 | 说明 |
|------|:-----------------:|:--------------:|------|
| S1 正面迎头 | 低（远距离检测率低） | 1 | 目标大部分时间在远距 |
| S2 高速交叉 | 中等 | 1 | 横穿阶段距离近 |
| S3 尾追 | 低 | 1 | 远距小目标 |
| S4 多目标 | 中等 | 3-5 | 多方向接近 |
| S5 机动 | 中等 | 1 | 正弦机动可跟踪 |
| S6 远距离 | 极低 | 0-1 | 持续远距 |
| S7 杂波 | 中等 | 1 | 无额外虚警轨迹 |
| S8 遮挡 | 中等 | 2 | 遮挡期靠预测维持 |

> 注：5s@10fps 仿真时间较短，目标多在远距离（>1000m），
> 检测率低导致跟踪确认帧数偏少。在 120fps×10s 全时长仿真中，
> 目标逐步接近后跟踪性能将显著提升。

---

## 6. 结果汇总

| 类别 | 测试数 | 通过数 | 状态 |
|------|:------:|:------:|:----:|
| EKF 单目标 | 7 | 7 | ✅ |
| 多目标跟踪 | 8 | 8 | ✅ |
| **总计** | **15** | **15** | **全部通过** |

---

## 7. 结论与建议

1. **EKF 滤波器数学正确**：预测/更新/收敛特性符合理论
2. **多目标关联可靠**：Hungarian 匹配在分离目标场景下 100% 正确
3. **轨迹管理状态机正确**：确认/丢失/删除转换符合设计
4. **建议改进**：
   - 增加外观特征辅助关联（减少交叉时的 ID 切换）
   - 实现自适应 Q 调整（Singer 机动检测）
   - 在 120fps 全帧率下验证高速跟踪连续性
